<!DOCTYPE html>
<html>  
  <head>
    <meta charset=utf-8>
    <h1>File Upload Demo</h1>
    <script src='FmCore.js'></script>
    <script src='FmFiles.js'></script>
    <script src='WsConnection.js'></script>   
    <script src='WsClient.js'></script>
  </head>
  <body>
    <div>
      <div style="display: inline">
        <span>
          Please select a file to upload:
          <input type="file" id="fileSelection" />
        </span>
      </div>
      <div style="display: inline">
        <button id="uploadButton">Upload</button>
      </div>
    </div>
    <script>
      (function(global, $) {
        var upload,
            connected;
                
        var resetUpload = function() {
          upload = undefined;
        };
        var connectedStateChanged = function(state) {
          connected = state;
          resetUpload();
        };
        var client = $.fm.ws.makeClient('perry', 17500, 'file-upload', {
          onError: function(error) {
            global.console.log('Connection Error: ' + error);            
            connectedStateChanged(false);
          },
          onConnectFailed: function() {
            global.console.log('Connect failed!');            
            connectedStateChanged(false);
          },
          onConnect: function() {
            global.console.log('Client connected.');                        
            connectedStateChanged(true);
          },
          onDisconnect: function() {
            global.console.log('Client disconnected.');            
            connectedStateChanged(false);
          }
        });        
        var uploadNextSlice = function(slice) {
          var args = {};  

          if (slice.endOfFile) {
            if (upload.id) {
              args.id = upload.id;
              args.fileName = upload.fileName;              
              args.state = 'DONE';
              client.uploadFile(args, {
                onSuccess: function(result) {
                  global.console.log('uploadFile-onSuccess: ' + result);
                  resetUpload();                
                },
                onFailure: function(error) {
                  global.console.log('uploadFile-onFailure: ' + error.message);
                  resetUpload();
                }            
              });
            }
          } else {
            if (upload.id) {
              args.id = upload.id;
              args.state = 'IN_PROGRESS';
            } else {
              args.state = 'STARTED';
            }
            
            args.fileName = upload.fileName;
            args.data = slice.data;
            client.uploadFile(args, {
              onSuccess: function(result) {
                global.console.log('uploadFile-onSuccess: ' + result);
                
                if (result === true) {
                  resetUpload();
                } else {
                  upload.id = result;
                  slice.next();                
                }                
              },
              onFailure: function(error) {
                global.console.log('uploadFile-onFailure: ' + error.message);
                resetUpload();
              }            
            });
          }                    
        }; 
        var abortUpload = function() {
          var args = {};                  
          
          if (upload.id) {
            args.id = upload.id;
            args.fileName = upload.fileName;
            args.state = 'ABORTED';
            client.uploadFile(args, {
              onSuccess: function(result) {
                global.console.log('uploadFile-onSuccess: ' + result);                              
                resetUpload();          
              },
              onFailure: function(error) {
                global.console.log('uploadFile-onFailure: ' + error.message);
                resetUpload();          
              }            
            });
          }
        }
        var uploadFile = function(file) {
          upload = {fileName: file.name};
          $.fm.files.slice(file, {
            size: (10 * 1024), 
            onSlice: uploadNextSlice,
            onError: abortUpload
          });
        };
        
        client.defRequest('uploadFile');        
        global.onload = function() {
          global.document
            .getElementById('uploadButton')
            .addEventListener('click', function() {
              var files = global.document.getElementById('fileSelection').files;
             
              if (connected && !upload && (files.length > 0)) {
                uploadFile(files[0]);
              }
            });          
          client.open();          
        };
      })(this, (this.jQuery || this));
    </script>   
  </body>
</html>
