<!DOCTYPE html>
<html>  
  <head>
    <meta charset=utf-8>
    <h1>File Upload Demo 04.05.2013</h1>
    <script src='FmCore.js'></script>
    <script src='FmFiles.js'></script>
    <script src='WsURLBuilder.js'></script>
    <script src='WsConnection.js'></script>
    <script src='WsChannel.js'></script>
    <script src='WsClient.js'></script>    
  </head>
  <body>
    <div>
      <div style="display: inline">
        <span>
          Please select a file to upload:
          <input type="file" id="fileSelection" />
        </span>
      </div>
      <div style="display: inline">
        <button id="uploadButton">Upload</button>
      </div>
    </div>
    <script>
      (function(global, $) {
        var connected,
            fileName,
            upload;
                
        var resetUpload = function() {
          fileName = undefined;
          upload = undefined;
        };
        var connectedStateChanged = function(state) {
          connected = state;
          resetUpload();
        };
        var connectionSpec = {port: 17500, serviceName: 'file-upload'},
            client = $.fm.ws.makeClient(connectionSpec, {
              onError: function(error) {
                global.console.log('Connection Error: ' + error);            
                connectedStateChanged(false);
              },
              onConnectFailed: function() {
                global.console.log('Connect failed!');            
                connectedStateChanged(false);
              },
              onConnect: function() {
                global.console.log('Client connected.');                        
                connectedStateChanged(true);
              },
              onDisconnect: function() {
                global.console.log('Client disconnected.');            
                connectedStateChanged(false);
              }
            }),
            fileUpload = client.defNamespace('fileUpload');
            
        var uploadNextSlice = function(slice) {
          if (slice.endOfFile) {
            if (upload) {
              upload.close({
                onSuccess: function(result) {
                  global.console.log('uploadFile-onSuccess: ' + result);
                  resetUpload();                
                },
                onFailure: function(error) {
                  global.console.log('uploadFile-onFailure: ' + error.message);
                  resetUpload();
                }            
              });
            }
          } else {
            if (upload) {
              upload.write(slice.data, {
                onSuccess: function(result) {
                  global.console.log('uploadFile-onSuccess: ' + result);
                  slice.next();                                  
                },
                onFailure: function(error) {
                  global.console.log('uploadFile-onFailure: ' + error.message);
                  resetUpload();
                }            
              });
            } else {
              upload = fileUpload.uploadFile();
              upload.open(fileName, slice.data, {
                onSuccess: function(result) {
                  global.console.log('uploadFile-onSuccess: ' + result);
                  slice.next();                                
                },
                onFailure: function(error) {
                  global.console.log('uploadFile-onFailure: ' + error.message);
                  resetUpload();
                }            
              });  
            }            
          }                    
        }; 
        var abortUpload = function() {
          if (upload) {            
            upload.abort({
              onSuccess: function(result) {
                global.console.log('uploadFile-onSuccess: ' + result);                              
                resetUpload();          
              },
              onFailure: function(error) {
                global.console.log('uploadFile-onFailure: ' + error.message);
                resetUpload();          
              }            
            });
          }
        }
        var uploadFile = function(file) {
          fileName = file.name;
          $.fm.files.slice(file, {
            size: (128 * 1024), 
            onSlice: uploadNextSlice,
            onError: abortUpload
          });
        };
        
        fileUpload.defChannel('uploadFile');                
        global.onload = function() {
          global.document
            .getElementById('uploadButton')
            .addEventListener('click', function() {
              var files = global.document.getElementById('fileSelection').files;
             
              if (connected && !upload && (files.length > 0)) {
                uploadFile(files[0]);
              }
            });          
          client.open();          
        };
      })(this, (this.jQuery || this));
    </script>   
  </body>
</html>

